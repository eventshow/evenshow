{% extends 'profile/preferences.html' %}
{% block content %}


<div class="container">
    <div class="title-share-edit">
        <div class="row">
            <div class="grid-example col s4 offset-s2">
                <h3 class="flow-text" id="name-host-serg">Editar datos</h3>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="grid-example col s11 offset-s1">


            <div class="center-form">
                <form class="form-eventshow-edit" id="edit-profile" method="POST" action="{% url 'update_profile' %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class="grid-example col s6">
                            <div class="validate-input" id="edit-event">
                                <label>USUARIO</label>
                                {{ form.username }}
                                <div class="form-errors">
                                    {{ form.username.errors }}
                                </div>
                            </div>
                        </div>
                        <div class="grid-example col s6">
                            <div class="validate-input" id="edit-event">
                                <label>EMAIL</label>
                                {{form.email}}
                                <div class="form-errors">
                                    {{ form.email.errors }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="grid-example col s6">
                            <div class="validate-input" id="edit-event">
                                <label>NOMBRE</label>
                                {{form.first_name}}
                                <div class="form-errors">
                                    {{ form.first_name.errors }}
                                </div>
                            </div>
                        </div>
                        <div class="grid-example col s6">
                            <div class="validate-input" id="edit-event">
                                <label>APELLIDOS</label>
                                {{form.last_name}}
                                <div class="form-errors">
                                    {{ form.last_name.errors }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="grid-example col s12 center-profile">
                            <div class="validate-input" id="edit-event">
                                <label>FECHA DE NACIMIENTO</label>
                                {{ profile_form.birthdate }}
                                <div class="form-errors">
                                    {{ profile_form.birthdate.errors }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="grid-example col s12 center-profile">
                            <div class="validate-input" id="edit-event">
                                <label>IMAGEN</label>
                                <input type="file" id="file_input" accept="image/*"/>
                                <img id="preview" src=""/>
                                {{profile_form.picture}}
                                <div class="form-errors">
                                    {{ profile_form.pciture.errors }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="grid-example col s12 center-profile">
                            <div class="validate-input" id="edit-event">
                                <label>SOBRE M√ç</label>
                                {{profile_form.bio}}
                                <div class="form-errors">
                                    {{ profile_form.bio.errors }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="grid-example col s3 offset-s8">
                            <button id="send-buttons-data" type="submit"
                                    class="waves-effect waves-light btn-large">Enviar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>(function() {
  document.getElementById("file_input").onchange = function(){
    var files = document.getElementById("file_input").files;
    var file = files[0];
    if(!file){
      return alert("No file selected.");
    }
    getSignedRequest(file);
  };
})();

function getSignedRequest(file){
  var xhr = new XMLHttpRequest();
  xhr.open("GET", file.name+"/"+file.type);

  xhr.onreadystatechange = function(){
      console.log(file.size)



        if(xhr.readyState === 4){
          if(xhr.status === 200){
            var response = JSON.parse(xhr.responseText);
            uploadFile(file, response.data, response.url);
          }
          else{
            alert("El archivo ha de ser una imagen");
          }
       }

      };
    if(file.size < 5000000){
      xhr.send();
    }else{
      alert("El archivo debe pesar menos de 5 mb");

    }
}


function uploadFile(file, s3Data, url){
  var xhr = new XMLHttpRequest();
  xhr.open("POST", s3Data.url);

  var postData = new FormData();
  for(key in s3Data.fields){
    postData.append(key, s3Data.fields[key]);
  }
  postData.append('file', file);
  xhr.onreadystatechange = function() {
    console.log(file.size);

    if(xhr.readyState === 4){
      if(xhr.status === 200 || xhr.status === 204){
        document.getElementById("preview").src = url;
        document.getElementById("avatar-url").value = url;
      }
      else{
        alert("No se ha podido subir el archivo");
      }
   }

  };
  xhr.send(postData);
}

</script>
{% endblock %}