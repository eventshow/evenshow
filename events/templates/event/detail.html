{% extends 'base.html' %}
{% block content %}
{% load static %}
{% if user.is_authenticated %}
<img class="img-detail-auth" src="{{object.picture}}">
{% else %}
<img class="img-detail" src="{{object.picture}}">
{% endif %}
<div class="principal-detail">
    <div class="col m6 rectangle-info" id="host-detail">
        <img class="img-host" alt='anfitrion' src="{{object.created_by.profile.picture}}">
        <div class="col m5 host-rating">
            <i class="fa fa-star"><i
                    class="rating-search">&nbsp{{event.created_by.profile.avg_host_score|floatformat:1|default_if_none:"n/a"|default:"n/a" }}</i></i>
        </div>
    </div>
    <div class="col m6 rectangle-info-title">
        <h1 class="sep-title">{{object.title}}</h1>
    </div>
    <div class="col m6 rectangle-info separated2" id="detail-info">
        <h2 class="title-detail">duración</h2>
        <h2 class="subtitle-detail">{{ duration }}</h2>
    </div>
    <div class="col m6 rectangle-info separated6" id="detail-info">
        <h2 class="title-detail">aforo</h2>
        <h2 class="subtitle-detail">{{attendees}} / {{object.capacity}}</h2>
    </div>
    <div class="col m6 rectangle-info separated7" id="detail-info">
        <h2 class="title-detail">edad mín.</h2>
        <h2 class="subtitle-detail">{{ object.min_age }}</h2>
    </div>
    <div class="col m6 rectangle-info separated4" id="detail-info">
        <h2 class="title-detail">idioma</h2>
        <h2 class="subtitle-detail">{{ object.lang }}</h2>
        {% if user.is_authenticated %}
        {% if user_is_owner %}
        <h3 class="warning-own" href="">Propietario</h3>
        {% elif not user_is_old_enough %}
        <h3 class="warning-young">No tienes la edad suficiente</h3>
        {% elif event_is_full %}
        <h3 class="warning-full" href="">Aforo completo</h3>
        {% elif event.has_started %}
        <h3 class="warning-full" href="">Ya ha empezado</h3>
        {% elif event.has_finished %}
        <h3 class="warning-full" href="">Ya ha terminado</h3>
        {% elif user_is_enrolled %}
        <h3 class="warning-full" href="">Ya estás inscrito</h3>
        {% elif event.created_by.username == 'deleted' %}
        <h3 class="warning-full" href="">No disponible</h3>
        {% elif user_can_enroll and not event.has_started %}
        <form action="{% url 'enroll_event' object.pk %}" method="POST">
            {% csrf_token %}
            {% if not have_creditcard %}
                <button type="button" id="abrir-popup" class="aves-effect waves-light btn-large button-detail-auth" onclick="abrirPopup();this.onclick=null">{{ object.price }}€</button>
                <div id="overlay"></div>
            {% else %}
            <button type="submit"
                class="aves-effect waves-light btn-large button-detail-auth">{{ object.price }}€</button>
            {% endif %}
        </form>
        {% endif %}
        {% elif event.created_by.username == 'deleted' %}
        <h3 class="warning-full" href="">No disponible</h3>
        {% else %}
        <a class="waves-effect waves-light btn-large button-detail" id="enroll" href="{% url 'login' %}">INSCRIBIRSE</a>
        {% endif %}
    </div>
    <div class="col m6 rectangle-info separated1" id="detail-info">
        <h2 class="title-detail">Hora comienzo</h2>
        <h2 class="subtitle-detail">{{ object.start_time }}</h2>
    </div>
    <div class="col m6 rectangle-info date-res" id="detail-info">
        <h2 class="title-detail">Fecha</h2>
        <h2 class="subtitle-detail">{{ object.start_day| date:"d M, Y" }}</h2>
    </div>
</div>
<div class="section-detail">
    <div class="col-3 title-section">
        <h1 class="title-section">Descripción</h1>
    </div>
    <div class="col-9 title-section">
        <h3 class="title-text">{{object.description}}</h3>
    </div>
    <hr>
</div>
<div class="section-detail2">
    <div class="col-3 title-section">
        <h1 class="title-section">Información extra</h1>
    </div>
    <div class="col-5 title-section">
        <h3 class="title-text">{{object.extra_info}}</h3>
    </div>
    <hr>
</div>
<div class="section-detail3">
    <div class="col-3 title-section">
        <h1 class="title-section">Anfitrión</h1>
    </div>
    <div class="col-9 title-section pos">
        <h3 class="name-host-detail" id="name-res">{{object.created_by.first_name}} {{object.created_by.last_name}}</h3>
        {% if event.created_by.username != 'deleted' %}
        <h3 class="host-bio">{{object.created_by.profile.bio}}</h3>
        {% endif %}
        <img class="img-bio" alt='anfitrion' src="{{object.created_by.profile.picture}}">
        <div class="rating-bio">
            <i class="fa fa-star"><i
                    class="rating-search">&nbsp{{event.created_by.profile.avg_host_score|floatformat:1|default_if_none:"n/a"|default:"n/a" }}</i></i>
        </div>
    </div>
    <hr>
    <div class="col-9 title-section pos">
        <h1 class="title-section">Dirección</h1>

        <h3 class="address-detail">{{object.location_street}} {{object.location_number}}<br> {{object.location_city}}
        </h3>
        <div class="col-md-7 map-detail">
            <br>
            <iframe src="https://www.google.com/maps/embed/v1/place?key={{gmaps_key}}&q={{event.g_location}}"></iframe>
            <br>
        </div>
    </div>
    <hr>
    {% if event.created_by.username != 'deleted' %}
    <div class="col-9 title-section pos">
        <h1 class="title-section">Comentarios de otros húespedes <br> asistieron a algún evento de este anfitrión</h1>
        {% for rating in object_list %}
        <div class="comments">
            <img class="img-comment" alt='' src="{{rating.created_by.profile.picture}}">
            <h3 class="name-host-detail user-comment">{{rating.created_by.username}}</h3>
            <div class="user-rat">
                <i class="fa fa-star"><i class="rating-search">&nbsp{{rating.score}}</i></i>
            </div>
            <h3 class="comment-detail">{{rating.comment}}</h3>
        </div>
        {% endfor %}
    </div>
    {% include 'pagination.html' %}
    {% endif %}
</div>
<style>
    body {
        background-size: cover;
        display: flex;
        min-height: 100vh;
        flex-direction: column;
    }

    main {
        flex: 1 0 auto;
    }

    .page-footer {
        width: 100%;
        margin-top: 25%;
    }

    @media only screen and (min-width: 320px) and (max-width: 568px) {

        .page-footer {
            width: 100%;
            margin-top: 308%;
        }
    }

    .StripeElement {
        width: 400px;
        height: 400px;
        color: #32325d;
        background-color: rgb(183, 35, 76);
        border: 1px solid transparent;
        border-radius: 4px;

        box-shadow: 0 1px 3px 0 #e6ebf1;
        -webkit-transition: box-shadow 150ms ease;
        transition: box-shadow 150ms ease;

    }

    input {
        padding: 10px 12px;
    }

    input:focus,
    .StripeElement--focus {
        box-shadow: 0 1px 3px 0 #cfd7df;
    }

    .StripeElement--invalid {
        border-color: #fa755a;
    }

    .StripeElement--webkit-autofill {
        background-color: #fefde5 !important;
    }

</style>
<script src="https://js.stripe.com/v3/"></script>
<script>
    var stripe = Stripe('{{stripe_key}}');

    var elements = stripe.elements();
    
    var style = {
        base: {
            color: '#ffffff',
            fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
            fontSmoothing: 'antialiased',
            fontSize: '16px',
            '::placeholder': {
            color: '#aab7c4'
            }
        },
        invalid: {
            color: '#fa755a',
            iconColor: '#fa755a'
        }
    };

    function abrirPopup(){
        var overlay = document.getElementById('overlay');
        var divPopup = document.createElement('div');

        divPopup.setAttribute('id', 'pop-up');
        overlay.appendChild(divPopup);

        var button = document.createElement('button');
        button.setAttribute('id', 'cerrar-popup');
        button.setAttribute('onclick', 'cerrarPopup();');
        button.innerHTML = 'Cerrar';
        button.setAttribute('type', 'button');
        divPopup.appendChild(button);

        var divCard = document.createElement('div');
        divCard.setAttribute('id', 'card-element');
        divPopup.appendChild(divCard);

        var divError = document.createElement('div');
        divError.setAttribute('id', 'card-errors');
        divPopup.appendChild(divError);
        

        if (!elements.getElement('card')){
            var card = elements.create('card', {style: style},);
        }else{
            var card = elements.getElement('card');
        }

        var check = document.createElement('input');
        check.type = 'checkbox';
        check.setAttribute('id', 'discount');
        check.setAttribute('name', 'checkbox');
        check.value = 'checkbox';
        check.setAttribute('onclick', 'check()');
        divPopup.appendChild(check);

        var span = document.createElement('span');
        span.setAttribute('for', 'discount');
        span.innerHTML = 'Descuento';
        span.setAttribute('onclick', 'check()');
        divPopup.appendChild(span);

        var divSubmit = document.createElement('div');
        divSubmit.setAttribute('id', 'submit');
        divPopup.appendChild(divSubmit);

        var submit = document.createElement('input');
        submit.setAttribute('type', 'submit');
        submit.setAttribute('class', 'aves-effect waves-light btn-large button-detail-auth');
        divSubmit.appendChild(submit);
        
        card.mount('#card-element');
        card.addEventListener('change', function(event){
            var displayError = document.getElementById('card-errors')
            if(event.error){
                displayError.textContent = event.error.message;
            }else{
                displayError.textContent = '';
            }
        });

        var form = document.getElementById('payment-form');
        form.addEventListener('submit', function(event){
            event.preventDefault();

            stripe.createToken(card).then(function(result) {
                if (result.error){
                    var errorElement = document.getElementById('card-errors');
                    displayError.textContent = event.error.message;
                }else{
                    stripeTokenHandler(result.token);
                }
            });
        });

        function stripeTokenHandler(token) {
            var form = document.getElementById('payment-form');
            var hiddenInput = document.createElement('input');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'stripeToken');
            hiddenInput.setAttribute('value', token.id);
            form.appendChild(hiddenInput);

            form.submit();
        };

    };
    
    function cerrarPopup() {
            var overlay = document.getElementById('overlay');
            var divPopup = document.getElementById('pop-up');

            overlay.removeChild(divPopup);

            document.getElementById('abrir-popup').setAttribute('onclick', 'abrirPopup();this.onclick=null');
        };

    function check(){
        var check = document.getElementById('discount').checked;
        if (!check){
            document.getElementById('discount').checked = true;
        }else{
            document.getElementById('discount').checked = false;
        }
    };
    
    
</script>
{% endblock %}